name: Deploy to EC2

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

      - name: Deploy via SSH
        run: |
          ssh -tt -i key.pem -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            sudo apt update
            sudo apt install -y docker.io docker-compose

            mkdir -p ~/salamander
            cd ~/salamander

            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }} .
            else
              git pull origin master
            fi

            echo "🚀 Building and starting containers"
            docker-compose down || true
            docker-compose up -d --build

            echo "⏳ Waiting for app..."
            for i in {1..10}; do
              if curl -s http://localhost:5000/ | grep -i "login\\|html\\|<!DOCTYPE"; then
                echo "✅ App is up"
                break
              fi
              echo "Still waiting... ($i/10)"
              sleep 3
              if [ $i -eq 10 ]; then
                echo "❌ App did not respond in time"
                exit 1
              fi
            done
          EOF
