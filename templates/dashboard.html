<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Salamander - Text Humanizer</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --warning: #f59e0b;
            --error: #ef4444;
            --dark: #0f172a;
            --darker: #020617;
            --gray: #64748b;
            --border: #334155;
        }

        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 100%);
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
            margin: 0;
            overflow-x: hidden;
        }

        .sidebar {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            z-index: 20;
        }

        .sidebar-collapsed {
            width: 60px;
        }

        .sidebar-expanded {
            width: 280px;
        }

        .main-content {
            transition: margin-left 0.3s ease;
            width: 100%;
        }

        .main-content-collapsed {
            margin-left: 60px;
        }

        .main-content-expanded {
            margin-left: 280px;
        }

        .playground-container {
            height: calc(100vh - 64px);
            display: flex;
            flex-direction: row;
            gap: 1.5rem;
            padding: 1.5rem;
        }

        .panel {
            flex: 1;
            min-width: 0;
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
        }

        .panel textarea {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            transition: border-color 0.2s ease;
            resize: none;
        }

        .panel textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1e293b;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #64748b;
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .gradient-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .premium-btn {
            background: linear-gradient(135deg, var(--warning), #f97316);
        }

        .btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        .sidebar-item {
            transition: all 0.2s ease;
        }

        .sidebar-item:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
        }

        .sidebar-item.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .tooltip {
            position: relative;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            background-color: #334155;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 6px 12px;
            position: absolute;
            z-index: 10;
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            white-space: nowrap;
        }

        .sidebar-collapsed .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .notification {
            animation: slideInRight 0.3s ease-out;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-exit {
            animation: fadeOut 0.3s ease-out forwards;
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }

        .ultra-toggle {
            width: 50px;
            height: 26px;
            border-radius: 13px;
            background-color: #334155;
            transition: background-color 0.3s ease;
        }

        .ultra-toggle-dot {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background-color: #e2e8f0;
            transition: transform 0.3s ease;
            margin: 2px;
        }

        .ultra-toggle.active {
            background: linear-gradient(135deg, var(--warning), #f97316);
        }

        .ultra-toggle.active .ultra-toggle-dot {
            transform: translateX(24px);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #64748b;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .error-modal {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .text-center-important {
            text-align: center !important;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 280px;
                transform: translateX(-100%);
            }

            .sidebar-collapsed {
                transform: translateX(-100%);
            }

            .sidebar-expanded {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0 !important;
            }

            .main-content-collapsed,
            .main-content-expanded {
                margin-left: 0;
            }

            .playground-container {
                flex-direction: column;
                height: auto;
                gap: 1rem;
            }

            .panel {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
<!-- Notification Container -->
<div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar sidebar-collapsed flex flex-col">
    <div class="h-16 flex items-center px-4 border-b border-slate-700">
        <div class="flex items-center w-full">
            <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center text-white font-bold">
                S
            </div>
            <div id="logo-text" class="ml-3 hidden">
                <h1 class="text-lg font-semibold text-white">Salamander</h1>
                <p class="text-xs text-slate-400">Text Humanizer</p>
            </div>
            </div>
        </div>

    <nav class="flex-1 px-4 py-3 space-y-2">
        <div id="nav-expanded" class="hidden">
            <a href="/" class="sidebar-item active flex items-center space-x-3 p-3 rounded-lg">
                <i class="fas fa-magic"></i>
                <span class="nav-text">Humanizer</span>
            </a>
            <a href="/history" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg">
                    <i class="fas fa-history"></i>
                <span class="nav-text">History</span>
            </a>
            <a href="/purchase" class="sidebar-item flex items-center space-x-3 p-3 rounded-lg">
                <i class="fas fa-crown"></i>
                <span class="nav-text">Upgrade</span>
            </a>
            </div>
        <div id="nav-collapsed" class="flex flex-col items-center space-y-4">
            <a href="/" class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700 tooltip">
                <i class="fas fa-magic"></i>
                <span class="tooltiptext">Humanizer</span>
            </a>
            <a href="/history" class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700 tooltip">
                <i class="fas fa-history"></i>
                <span class="tooltiptext">History</span>
            </a>
            <a href="/purchase" class="text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700 tooltip">
                <i class="fas fa-crown"></i>
                <span class="tooltiptext">Upgrade</span>
            </a>
        </div>
    </nav>

    <div class="border-t border-slate-700 p-4">
        <div id="user-expanded" class="hidden">
            <div class="flex items-center space-x-3 p-3 rounded-lg hover:bg-slate-700">
                <div id="user-avatar"
                     class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white">
                    <span id="user-initial">G</span>
                </div>
                <div class="flex-1">
                    <p id="user-name" class="text-sm font-medium text-white truncate">Guest</p>
                    <p id="user-plan" class="text-xs text-slate-400">Free Plan</p>
                </div>
            </div>
            <button id="auth-button"
                    class="w-full mt-2 px-3 py-2 text-sm text-indigo-400 hover:text-indigo-300 text-center-important">
                Log In
            </button>
        </div>
        <div id="user-collapsed" class="flex justify-center">
            <div id="user-avatar-collapsed"
                 class="w-10 h-10 rounded-full bg-indigo-600 flex items-center justify-center text-white">
                <span id="user-initial-collapsed">G</span>
            </div>
        </div>
    </div>
</aside>

<!-- Main Content -->
<div id="main-content" class="main-content main-content-collapsed flex flex-col">
    <header class="h-16 bg-slate-800 flex items-center px-6 shadow-md">
        <div class="flex items-center flex-1">
            <button id="mobile-menu-btn"
                    class="mr-4 text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700 md:hidden">
                <i class="fas fa-bars"></i>
            </button>
            <button id="toggle-sidebar"
                    class="mr-4 text-slate-400 hover:text-white p-2 rounded-full hover:bg-slate-700 hidden md:block">
                <i id="sidebar-icon" class="fas fa-chevron-right"></i>
            </button>
            <div class="flex-1 text-center">
                <h1 class="text-lg font-semibold text-white">Text Humanizer</h1>
                <p class="text-xs text-slate-400">Transform AI text into natural, human-like content</p>
            </div>
        </div>
        <div class="flex items-center space-x-6">
            <div class="flex items-center space-x-3">
                <span class="text-sm text-slate-300 text-center-important">Ultra Mode</span>
                <div id="ultra-toggle-container" class="ultra-toggle">
                    <div class="ultra-toggle-dot"></div>
                </div>
                <input type="checkbox" id="ultra-toggle" class="sr-only">
            </div>
            <div class="flex items-center space-x-3">
                <div id="credits-display"
                     class="px-3 py-1 bg-slate-700 rounded-md flex items-center space-x-2 justify-center">
                    <i class="fas fa-coins text-yellow-400"></i>
                    <span id="credits-count" class="text-sm text-center-important">0 words</span>
                </div>
                <a href="/purchase" class="tooltip">
                    <button class="btn px-3 py-1 text-sm text-white premium-btn rounded-md">
                        <i class="fas fa-cart-plus mr-1"></i> Buy More
                        <span class="tooltiptext">Purchase additional words</span>
                    </button>
                </a>
            </div>
            <div id="header-user-actions">
                <button id="header-login-btn"
                        class="text-slate-300 hover:text-white px-3 py-1 text-sm text-center-important">
                    Log In
                </button>
            </div>
        </div>
    </header>

    <div class="playground-container">
        <div class="panel">
            <div class="h-14 flex items-center justify-between px-4 border-b border-slate-700">
                <h3 class="text-sm font-semibold text-white flex items-center">
                    <i class="fas fa-edit mr-2 text-blue-400"></i> Input Text
                </h3>
                <div class="flex items-center space-x-4">
                    <span id="input-word-count" class="text-sm text-slate-400 text-center-important">0 words</span>
                    <button id="paste-btn"
                            class="text-slate-400 hover:text-blue-400 p-1 rounded-full hover:bg-slate-700 tooltip">
                        <i class="fas fa-clipboard"></i>
                        <span class="tooltiptext">Paste from clipboard</span>
                    </button>
                </div>
            </div>
            <div class="flex-1 p-4">
                    <textarea
                            id="input-text"
                            class="w-full h-full p-4 rounded-lg custom-scrollbar"
                            placeholder="Paste your AI-generated text here..."
                    ></textarea>
            </div>
            <div class="h-16 flex items-center justify-between px-4 border-t border-slate-700">
                <button id="clear-btn"
                        class="btn px-3 py-1 text-sm text-slate-400 hover:text-white flex items-center hover:bg-slate-700 rounded-md">
                    <i class="fas fa-trash-alt mr-1"></i> Clear
                </button>
                <button id="humanize-btn" class="btn px-6 py-2 text-sm font-medium text-white gradient-btn rounded-md">
                    <i class="fas fa-magic mr-2"></i> Humanize
                </button>
            </div>
        </div>

        <div class="panel">
            <div class="h-14 flex items-center justify-between px-4 border-b border-slate-700">
                <h3 class="text-sm font-semibold text-white flex items-center">
                    <i class="fas fa-check-circle mr-2 text-green-400"></i> Humanized Output
                </h3>
                <div class="flex items-center space-x-4">
                    <span id="output-word-count" class="text-sm text-slate-400 text-center-important">0 words</span>
                    <button id="copy-btn"
                            class="text-slate-400 hover:text-green-400 p-1 rounded-full hover:bg-slate-700 tooltip"
                            disabled>
                        <i class="far fa-copy"></i>
                        <span class="tooltiptext">Copy to clipboard</span>
                    </button>
                </div>
            </div>
            <div id="output-container" class="flex-1 p-4 overflow-y-auto custom-scrollbar">
                <div id="output-text" class="w-full h-full p-4 bg-slate-700 rounded-lg text-slate-200">
                    <div class="empty-state">
                        <i class="fas fa-robot text-3xl mb-3"></i>
                        <p>Your humanized text will appear here</p>
                        <p class="text-sm mt-1">Start by entering text in the input panel</p>
                    </div>
                </div>
            </div>
            <div class="h-16 flex items-center justify-between px-4 border-t border-slate-700">
                <div class="flex items-center space-x-3">
                    <div class="px-2 py-1 text-xs bg-slate-700 rounded-md">
                        <i class="fas fa-brain mr-1 text-purple-400"></i>
                        Readability: <span id="readability-score">-</span>
                    </div>
                    <div class="px-2 py-1 text-xs bg-slate-700 rounded-md">
                        <i class="fas fa-fingerprint mr-1 text-blue-400"></i>
                        Uniqueness: <span id="uniqueness-score">-</span>
                    </div>
                </div>
                <span class="text-xs text-slate-400">Last updated: <span id="last-updated">Never</span></span>
                </div>
            </div>
        </div>
    </div>

<!-- Error Modal -->
<div id="error-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="error-modal rounded-lg p-6 max-w-md w-full">
        <div class="flex items-center mb-4">
            <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
            <h2 class="text-lg font-semibold text-white">Error</h2>
        </div>
        <p id="error-message" class="text-slate-300 mb-6"></p>
        <div class="flex justify-end space-x-3">
            <button id="error-close-btn"
                    class="px-4 py-2 text-sm text-slate-300 bg-slate-700 rounded-md hover:bg-slate-600">
                Close
            </button>
            <a id="error-action-btn" href="#"
               class="px-4 py-2 text-sm text-white bg-indigo-600 rounded-md hover:bg-indigo-500 hidden">
                Take Action
            </a>
            </div>
    </div>
</div>

<script>
    // Firebase Configuration
    const firebaseConfig = JSON.parse('{{ firebase_config | safe }}');
    firebase.initializeApp(firebaseConfig);

    // DOM Elements
    const elements = {
        sidebar: document.getElementById('sidebar'),
        toggleSidebarBtn: document.getElementById('toggle-sidebar'),
        mobileMenuBtn: document.getElementById('mobile-menu-btn'),
        sidebarIcon: document.getElementById('sidebar-icon'),
        logoText: document.getElementById('logo-text'),
        navExpanded: document.getElementById('nav-expanded'),
        navCollapsed: document.getElementById('nav-collapsed'),
        userExpanded: document.getElementById('user-expanded'),
        userCollapsed: document.getElementById('user-collapsed'),
        mainContent: document.getElementById('main-content'),
        ultraToggle: document.getElementById('ultra-toggle'),
        ultraToggleContainer: document.getElementById('ultra-toggle-container'),
        humanizeBtn: document.getElementById('humanize-btn'),
        inputText: document.getElementById('input-text'),
        inputWordCount: document.getElementById('input-word-count'),
        outputText: document.getElementById('output-text'),
        outputWordCount: document.getElementById('output-word-count'),
        copyBtn: document.getElementById('copy-btn'),
        clearBtn: document.getElementById('clear-btn'),
        pasteBtn: document.getElementById('paste-btn'),
        readabilityScore: document.getElementById('readability-score'),
        uniquenessScore: document.getElementById('uniqueness-score'),
        lastUpdated: document.getElementById('last-updated'),
        creditsDisplay: document.getElementById('credits-display'),
        creditsCount: document.getElementById('credits-count'),
        userName: document.getElementById('user-name'),
        userPlan: document.getElementById('user-plan'),
        userAvatar: document.getElementById('user-avatar'),
        userInitial: document.getElementById('user-initial'),
        userAvatarCollapsed: document.getElementById('user-avatar-collapsed'),
        userInitialCollapsed: document.getElementById('user-initial-collapsed'),
        authButton: document.getElementById('auth-button'),
        headerUserActions: document.getElementById('header-user-actions'),
        notificationContainer: document.getElementById('notification-container'),
        errorModal: document.getElementById('error-modal'),
        errorMessage: document.getElementById('error-message'),
        errorCloseBtn: document.getElementById('error-close-btn'),
        errorActionBtn: document.getElementById('error-action-btn')
    };

    // State
    let user = null;
    let isSidebarOpen = false;

    // Sidebar Toggle
    function toggleSidebar() {
        isSidebarOpen = !isSidebarOpen;
        elements.sidebar.classList.toggle('sidebar-collapsed', !isSidebarOpen);
        elements.sidebar.classList.toggle('sidebar-expanded', isSidebarOpen);
        elements.mainContent.classList.toggle('main-content-collapsed', !isSidebarOpen);
        elements.mainContent.classList.toggle('main-content-expanded', isSidebarOpen);
        elements.sidebarIcon.classList.toggle('fa-chevron-right', !isSidebarOpen);
        elements.sidebarIcon.classList.toggle('fa-chevron-left', isSidebarOpen);
        elements.logoText.classList.toggle('hidden', !isSidebarOpen);
        elements.navExpanded.classList.toggle('hidden', !isSidebarOpen);
        elements.navCollapsed.classList.toggle('hidden', isSidebarOpen);
        elements.userExpanded.classList.toggle('hidden', !isSidebarOpen);
        elements.userCollapsed.classList.toggle('hidden', isSidebarOpen);
    }

    elements.toggleSidebarBtn.addEventListener('click', toggleSidebar);
    elements.mobileMenuBtn.addEventListener('click', toggleSidebar);

    // Auto-close sidebar on mobile when clicking outside
    document.addEventListener('click', (e) => {
        if (window.innerWidth <= 768 && isSidebarOpen && !elements.sidebar.contains(e.target) && !elements.mobileMenuBtn.contains(e.target)) {
            toggleSidebar();
        }
    });

    // Ultra Mode Toggle
    elements.ultraToggleContainer.addEventListener('click', () => {
        if (user && !user.is_premium && !elements.ultraToggle.checked) {
            showError('Ultra Mode is a premium feature. Upgrade your plan to use it.', '/purchase');
            return;
        }
        elements.ultraToggle.checked = !elements.ultraToggle.checked;
        elements.ultraToggleContainer.classList.toggle('active', elements.ultraToggle.checked);
        elements.humanizeBtn.classList.toggle('gradient-btn', !elements.ultraToggle.checked);
        elements.humanizeBtn.classList.toggle('premium-btn', elements.ultraToggle.checked);
        elements.humanizeBtn.innerHTML = elements.ultraToggle.checked
            ? '<i class="fas fa-bolt mr-2"></i> Ultra Humanize'
            : '<i class="fas fa-magic mr-2"></i> Humanize';
    });

    // Input Word Count
    elements.inputText.addEventListener('input', () => {
        const words = elements.inputText.value.trim().split(/\s+/).filter(w => w).length;
        elements.inputWordCount.textContent = `${words} words`;
    });

    // Clear Button
    elements.clearBtn.addEventListener('click', () => {
        elements.inputText.value = '';
        elements.inputWordCount.textContent = '0 words';
        resetOutput();
    });

    // Paste Button
    elements.pasteBtn.addEventListener('click', async () => {
        try {
            const text = await navigator.clipboard.readText();
            elements.inputText.value = text;
            const words = text.trim().split(/\s+/).filter(w => w).length;
            elements.inputWordCount.textContent = `${words} words`;
            showNotification('Text pasted from clipboard!', 'success');
        } catch (error) {
            showError('Failed to paste from clipboard.');
        }
    });

    // Copy Button
    elements.copyBtn.addEventListener('click', async () => {
        if (elements.outputText.querySelector('.empty-state')) return;
        try {
            await navigator.clipboard.writeText(elements.outputText.innerText);
            const tooltipText = elements.copyBtn.querySelector('.tooltiptext');
            const originalText = tooltipText.innerText;
            tooltipText.innerText = 'Copied!';
            setTimeout(() => {
                tooltipText.innerText = originalText;
            }, 2000);
            showNotification('Text copied to clipboard!', 'success');
        } catch (error) {
            showError('Failed to copy text.');
        }
    });

    // Humanize Button
    elements.humanizeBtn.addEventListener('click', async () => {
        const text = elements.inputText.value.trim();
        if (!text) {
            showError('Please enter text to humanize.');
            return;
        }
        if (!user && text.split(/\s+/).filter(w => w).length > 100) {
            showError('Free users are limited to 100 words per request. Log in or upgrade for more.', '/login');
            return;
        }

        elements.outputText.innerHTML = `
                <div class="flex items-center justify-center h-full">
                    <svg class="animate-spin h-8 w-8 text-indigo-500 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>Humanizing...</span>
                </div>
            `;
        elements.humanizeBtn.disabled = true;
        elements.copyBtn.disabled = true;

        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            const response = await fetch('/api/humanize', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken  // <-- CSRF token added here
                },
                body: JSON.stringify({text, ultra_mode: elements.ultraToggle.checked})
            });
            const data = await response.json();

            if (!response.ok) {
                throw new Error(data.error || 'Failed to humanize text');
            }

            elements.outputText.innerHTML = `<div class="fade-in">${data.result}</div>`;
            const outputWords = data.result.split(/\s+/).filter(w => w).length;
            elements.outputWordCount.textContent = `${outputWords} words`;
            elements.readabilityScore.textContent = data.stats.readability;
            elements.uniquenessScore.textContent = data.stats.uniqueness;
            elements.lastUpdated.textContent = new Date().toLocaleString();
            elements.copyBtn.disabled = false;
            if (user) {
                await updateCredits();
            }
            showNotification('Text humanized successfully!', 'success');
        } catch (error) {
            const message = error.message.includes('Insufficient credits') ?
                'You donâ€™t have enough credits. Purchase more to continue.' :
                error.message.includes('expired') ?
                    'Your subscription has expired. Renew to continue.' :
                    error.message;
            const actionUrl = error.message.includes('credits') || error.message.includes('expired') ? '/purchase' : null;
            showError(message, actionUrl);
            resetOutput();
        } finally {
            elements.humanizeBtn.disabled = false;
            }
    });

    // Authentication
    function updateUIForUser(userData) {
        user = userData;
        if (user) {
            elements.userName.textContent = user.name || 'User';
            elements.userPlan.textContent = user.is_premium ? 'Premium Plan' : 'Free Plan';
            const initial = user.name ? user.name[0].toUpperCase() : 'U';
            elements.userInitial.textContent = initial;
            elements.userInitialCollapsed.textContent = initial;
            elements.userAvatar.innerHTML = user.picture ? `<img src="${user.picture}" class="w-10 h-10 rounded-full" alt="User Avatar">` : `<span>${initial}</span>`;
            elements.userAvatarCollapsed.innerHTML = user.picture ? `<img src="${user.picture}" class="w-10 h-10 rounded-full" alt="User Avatar">` : `<span>${initial}</span>`;
            elements.authButton.textContent = 'Log Out';
            elements.authButton.removeEventListener('click', signInWithGoogle);
            elements.authButton.addEventListener('click', signOut);
            elements.headerUserActions.innerHTML = `
                    <div class="flex items-center space-x-3 justify-center">
                        <span class="text-sm text-slate-300 text-center-important">${user.name}</span>
                        <button id="header-logout-btn" class="text-slate-300 hover:text-white px-3 py-1 text-sm text-center-important">Log Out</button>
                    </div>
                `;
            document.getElementById('header-logout-btn').addEventListener('click', signOut);
            elements.creditsCount.textContent = user.is_premium ? 'Unlimited' : `${user.word_credits || 0} words`;
        } else {
            elements.userName.textContent = 'Guest';
            elements.userPlan.textContent = 'Free Plan';
            elements.userInitial.textContent = 'G';
            elements.userInitialCollapsed.textContent = 'G';
            elements.userAvatar.innerHTML = '<span>G</span>';
            elements.userAvatarCollapsed.innerHTML = '<span>G</span>';
            elements.authButton.textContent = 'Log In';
            elements.authButton.removeEventListener('click', signOut);
            elements.authButton.addEventListener('click', signInWithGoogle);
            elements.headerUserActions.innerHTML = `
                    <button id="header-login-btn" class="text-slate-300 hover:text-white px-3 py-1 text-sm text-center-important">Log In</button>
                `;
            document.getElementById('header-login-btn').addEventListener('click', signInWithGoogle);
            elements.creditsCount.textContent = '1000 words';
        }
    }

    async function signInWithGoogle() {
        const provider = new firebase.auth.GoogleAuthProvider();
        try {
            const result = await firebase.auth().signInWithPopup(provider);
            const idToken = await result.user.getIdToken();
            const response = await fetch('/auth/google', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({idToken})
            });
            if (response.ok) {
                const userData = await response.json();
                updateUIForUser(userData);
                showNotification('Logged in successfully!', 'success');
            } else {
                throw new Error('Authentication failed');
            }
        } catch (error) {
            showError('Failed to sign in with Google.');
        }
    }

    async function signOut() {
        try {
            await firebase.auth().signOut();
            await fetch('/logout', {method: 'GET'});
            updateUIForUser(null);
            showNotification('Logged out successfully!', 'success');
        } catch (error) {
            showError('Failed to sign out.');
        }
    }

    firebase.auth().onAuthStateChanged(async firebaseUser => {
        try {
            if (firebaseUser) {
                const idToken = await firebaseUser.getIdToken();
                const response = await fetch('/auth/google', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({idToken})
                    });
                if (response.ok) {
                    const userData = await response.json();
                    updateUIForUser(userData);
                } else {
                    updateUIForUser(null);
                }
            } else {
                updateUIForUser(null);
            }
        } catch (error) {
            updateUIForUser(null);
            showError('Failed to verify authentication status.');
        }
    });

    // Notifications
    function showNotification(message, type) {
        const notification = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-red-600';
        notification.className = `notification ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg flex items-center space-x-2`;
        notification.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'warning' ? 'fa-exclamation-triangle' : 'fa-times-circle'}"></i>
                <span>${message}</span>
            `;
        elements.notificationContainer.appendChild(notification);
        setTimeout(() => {
            notification.classList.add('notification-exit');
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Error Handling
    function showError(message, actionUrl = null) {
        elements.errorMessage.textContent = message;
        elements.errorModal.classList.remove('hidden');
        elements.errorActionBtn.classList.toggle('hidden', !actionUrl);
        if (actionUrl) {
            elements.errorActionBtn.href = actionUrl;
            elements.errorActionBtn.textContent = actionUrl.includes('purchase') ? 'Upgrade Now' : 'Log In';
        }
    }

    elements.errorCloseBtn.addEventListener('click', () => {
        elements.errorModal.classList.add('hidden');
    });

    elements.errorModal.addEventListener('click', (e) => {
        if (e.target === elements.errorModal) {
            elements.errorModal.classList.add('hidden');
        }
    });

    // Utility Functions
    function resetOutput() {
        elements.outputText.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-robot text-3xl mb-3"></i>
                    <p>Your humanized text will appear here</p>
                    <p class="text-sm mt-1">Start by entering text in the input panel</p>
                </div>
            `;
        elements.outputWordCount.textContent = '0 words';
        elements.readabilityScore.textContent = '-';
        elements.uniquenessScore.textContent = '-';
        elements.lastUpdated.textContent = 'Never';
        elements.copyBtn.disabled = true;
    }

    async function updateCredits() {
        if (!user) return;
        try {
            const response = await fetch('/api/user');
            const data = await response.json();
            user.word_credits = data.word_credits;
            user.is_premium = data.is_premium;
            elements.creditsCount.textContent = user.is_premium ? 'Unlimited' : `${data.word_credits || 0} words`;
        } catch (error) {
            showError('Failed to update credits.');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        resetOutput();
        elements.inputText.value = "The concept of artificial intelligence has evolved dramatically in recent years. From simple rule-based systems to complex neural networks, AI has transformed how we approach computing problems. This essay explores the ethical implications of AI development and how society might adapt to increasingly autonomous systems.";
        elements.inputWordCount.textContent = `${elements.inputText.value.trim().split(/\s+/).filter(w => w).length} words`;

        // Initialize sidebar as collapsed on desktop
        if (window.innerWidth > 768) {
            isSidebarOpen = false;
            elements.sidebar.classList.add('sidebar-collapsed');
            elements.sidebar.classList.remove('sidebar-expanded');
            elements.mainContent.classList.add('main-content-collapsed');
            elements.mainContent.classList.remove('main-content-expanded');
            elements.logoText.classList.add('hidden');
            elements.navExpanded.classList.add('hidden');
            elements.navCollapsed.classList.remove('hidden');
            elements.userExpanded.classList.add('hidden');
            elements.userCollapsed.classList.remove('hidden');
            elements.toggleSidebarBtn.classList.remove('hidden');
        }

        // Handle window resize for mobile responsiveness
        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768 && isSidebarOpen) {
                toggleSidebar();
            }
        });
    });
</script>
</body>
</html>